<!DOCTYPE html>
<html lang="en">
  <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />

    <title>grtnr.com</title>

    <meta charset="utf-8" />
    <link rel="stylesheet" href="../theme/css/poole.css"/>
    <link rel="stylesheet" href="../theme/css/syntax.css"/>
    <link rel="stylesheet" href="../theme/css/lanyon.css"/>
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">
    <link rel="stylesheet" href="../theme/css/styles.css"/>




  </head>

  <body>
<!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">
<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <div class="profile">
      <img src="../theme/img/profile.png"/>
    </div>
  </div>

  <nav class="sidebar-nav">
  <a class="sidebar-nav-item" href="../">All</a>

      <a class="sidebar-nav-item" href="../category/misc.html">misc</a>

  <a class="sidebar-nav-item" href="https://getpelican.com/">Pelican</a>
  <a class="sidebar-nav-item" href="https://www.python.org/">Python.org</a>
  <a class="sidebar-nav-item" href="https://palletsprojects.com/p/jinja/">Jinja2</a>
  <a class="sidebar-nav-item" href="#">You can modify those links in your config file</a>
  </nav>

  <div class="sidebar-item">
    <p>
    <a href="https://twitter.com/tillg">&copy; @tillg</a> 2017
    </p>
    <p class="tiny-note">
      <a class="muted" href="https://github.com/thomaswilley/pelicanyan">pelicanyan v0.1</a>
    </p>
  </div>
</div>    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="../" title="Home">grtnr.com</a>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="posts">
<div class="post">
    <h1 class="post-title">
      Thoughts On Swift&nbsp;Architecture
    </h1>
    <span class="post-date">March 24, 2025</span>

    <ul>
<li><a href="#question">Question</a><ul>
<li><a href="#domain-models-data-models-and-mappers">Domain Models, Data Models, and&nbsp;Mappers</a></li>
<li><a href="#repository">Repository</a></li>
</ul>
</li>
<li><a href="#answer">Answer</a></li>
</ul>
<p>I heard this really nice podcast yesterday on how to structure different model types in Swift: Domain models that are my internal representation, Data Models (or DTOs) that are the external representation, and View Models that are the representation for my <span class="caps">UI</span>:</p>
<p><a href="https://podcasts.apple.com/de/podcast/developer-podcast/id1467065787?i=1000698509743"><img alt="Developer Podcast" src="https://img.transistor.fm/8oNIHMVZfJuWvHxD2UmRV8s-zz2ZDfXC-Sud2dJRo24/rs:fill:400:400:1/q:60/aHR0cHM6Ly9pbWct/dXBsb2FkLXByb2R1/Y3Rpb24udHJhbnNp/c3Rvci5mbS9lMjg4/Y2UwYzYzMjlmN2My/Y2U4MWE3ZmYwNDJk/YTZhZC5wbmc.webp"></a></p>
<p>This post basically is a question that I added to the <a href="https://discord.com/invite/j57uchzUa9">Discord that goes with the Podcast</a>.</p>
<h1>Question</h1>
<p>I&#8217;m a Swift Rookie, and many aspects are still unclear to me. Based on the example you guys used in the podcast, I will try to fill out the gaps in my&nbsp;understanding.</p>
<h2>Domain Models, Data Models, and&nbsp;Mappers</h2>
<p>The example is a ToDo app and so the main entity is the <strong>Task</strong>. So I would have a Domain&nbsp;model <code>Task</code> that looks like&nbsp;this:</p>
<div class="highlight"><pre><span></span><code><span class="kd">struct</span> <span class="nc">Task</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">id</span><span class="p">:</span> <span class="n">UUID</span>
    <span class="kd">let</span> <span class="nv">title</span><span class="p">:</span> <span class="nb">String</span>
    <span class="kd">let</span> <span class="nv">description</span><span class="p">:</span> <span class="nb">String</span>
    <span class="kd">let</span> <span class="nv">dueDate</span><span class="p">:</span> <span class="n">Date</span>
    <span class="kd">let</span> <span class="nv">isCompleted</span><span class="p">:</span> <span class="nb">Bool</span>
<span class="p">}</span>
</code></pre></div>

<p>As I want to store my tasks in CloudKit, I need a Data Model that is compatible with CloudKit. So I&nbsp;need <code>CKRecord</code> objects that represent tasks. According to my understanding, they are built like&nbsp;this:</p>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nf">mapTaskToCKRecord</span><span class="p">(</span><span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="bp">CKRecord</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">record</span> <span class="p">=</span> <span class="bp">CKRecord</span><span class="p">(</span><span class="n">recordType</span><span class="p">:</span> <span class="s">&quot;task&quot;</span><span class="p">)</span>
    <span class="n">record</span><span class="p">[</span><span class="s">&quot;id&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="n">task</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="bp">CKRecordValue</span>
    <span class="n">record</span><span class="p">[</span><span class="s">&quot;title&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="n">task</span><span class="p">.</span><span class="n">title</span> <span class="k">as</span> <span class="bp">CKRecordValue</span>
    <span class="n">record</span><span class="p">[</span><span class="s">&quot;description&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="n">task</span><span class="p">.</span><span class="n">description</span> <span class="k">as</span> <span class="bp">CKRecordValue</span>
    <span class="n">record</span><span class="p">[</span><span class="s">&quot;dueDate&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="n">task</span><span class="p">.</span><span class="n">dueDate</span> <span class="k">as</span> <span class="bp">CKRecordValue</span>
    <span class="n">record</span><span class="p">[</span><span class="s">&quot;isCompleted&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="n">task</span><span class="p">.</span><span class="n">isCompleted</span> <span class="k">as</span> <span class="bp">CKRecordValue</span>
    <span class="k">return</span> <span class="n">record</span>
<span class="p">}</span>
</code></pre></div>

<p>And I would have the corresponding function to map&nbsp;a <code>CKRecord</code> back to&nbsp;a <code>Task</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nf">mapCKRecordToTask</span><span class="p">(</span><span class="n">record</span><span class="p">:</span> <span class="bp">CKRecord</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Task</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">id</span> <span class="p">=</span> <span class="n">record</span><span class="p">[</span><span class="s">&quot;id&quot;</span><span class="p">]</span> <span class="k">as</span><span class="p">!</span> <span class="n">UUID</span>
    <span class="kd">let</span> <span class="nv">title</span> <span class="p">=</span> <span class="n">record</span><span class="p">[</span><span class="s">&quot;title&quot;</span><span class="p">]</span> <span class="k">as</span><span class="p">!</span> <span class="nb">String</span>
    <span class="kd">let</span> <span class="nv">description</span> <span class="p">=</span> <span class="n">record</span><span class="p">[</span><span class="s">&quot;description&quot;</span><span class="p">]</span> <span class="k">as</span><span class="p">!</span> <span class="nb">String</span>
    <span class="kd">let</span> <span class="nv">dueDate</span> <span class="p">=</span> <span class="n">record</span><span class="p">[</span><span class="s">&quot;dueDate&quot;</span><span class="p">]</span> <span class="k">as</span><span class="p">!</span> <span class="n">Date</span>
    <span class="kd">let</span> <span class="nv">isCompleted</span> <span class="p">=</span> <span class="n">record</span><span class="p">[</span><span class="s">&quot;isCompleted&quot;</span><span class="p">]</span> <span class="k">as</span><span class="p">!</span> <span class="nb">Bool</span>
    <span class="k">return</span> <span class="n">Task</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">id</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span> <span class="n">dueDate</span><span class="p">:</span> <span class="n">dueDate</span><span class="p">,</span> <span class="n">isCompleted</span><span class="p">:</span> <span class="n">isCompleted</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<p>Questions:</p>
<ul>
<li><strong>Where</strong> do I put the mapping functions? Are they part on the Domain Model or the Data Model? I guess they rather belong to the the Data&nbsp;Model.</li>
<li><strong>Errors</strong>: How to deal with errors? For example, if&nbsp;the <code>CKRecord</code> does not contain a value&nbsp;for <code>id</code>, I would get a crash. Should I use optionals or throw an&nbsp;error?</li>
</ul>
<h2>Repository</h2>
<p>Then you mention the repository. Based on the earlier discussion on Discord, I would assume the repository only deals with Domain models. So it might look like&nbsp;this:</p>
<div class="highlight"><pre><span></span><code><span class="kd">protocol</span> <span class="nc">TaskRepository</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">getAllTasks</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="p">[</span><span class="n">Task</span><span class="p">]</span>
    <span class="kd">func</span> <span class="nf">getTaskById</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Task</span><span class="p">?</span>
    <span class="kd">func</span> <span class="nf">getTasksByCompletionStatus</span><span class="p">(</span><span class="n">isCompleted</span><span class="p">:</span> <span class="nb">Bool</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="p">[</span><span class="n">Task</span><span class="p">]</span>
    <span class="kd">func</span> <span class="nf">addTask</span><span class="p">(</span><span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">updateTask</span><span class="p">(</span><span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">deleteTask</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<p>And based on this protocol I could implement&nbsp;a <code>TaskRepositoryCloudKit</code> that uses the mapping functions to convert between Domain and Data Models and reflects all the <span class="caps">CRUD</span> operations that are made to the (in memory) TaskRepostory to the CloudKit&nbsp;database.</p>
<p>Next&nbsp;question:</p>
<ul>
<li><strong>Repository functions</strong>: Typically I would build functions from a repository that are beyond <span class="caps">CRUD</span>. For example&nbsp;a <code>getTasksDateRange</code> that returns the oldest and most recent due date. Where would I build this? I don&#8217;t want to put it&nbsp;in <code>TaskRepositoryCloudKit</code> as it would be the same logic when using a different storage (i.e. load all the tasks in memory, sort them, and return the first and last). As I can&#8217;t have functions in a protocol, wher do I put&nbsp;it?</li>
<li><strong>Naming</strong>: Is the naming I suggested reasonable? Is it how you would do it in Swift? I&nbsp;chose <code>TaskRepositoryCloudKit</code> so it is listed next to&nbsp;the <code>TaskRepository</code> in the Xcode file browser. If I would need other Data Models to interface a system Xyz I would call&nbsp;them <code>TaskRawXyz</code> - is that&nbsp;reasonable?</li>
</ul>
<h1>Answer</h1>
<p>I got a great <a href="https://discord.com/channels/1028834407374655518/1028846930182291526/1353860001411760228">answer</a> from <a href="https://pado.name">Cocoatype</a> on discord. And I am very grateful that he took the time to read and type the&nbsp;answer.</p>
<p>Here is Cocoatype&#8217;s answer for&nbsp;reference:</p>
<blockquote>
<p><strong>Where</strong> do I put the mapping functions? Are they part on the Domain Model or the Data Model? I guess they rather belong to the the Data Model.
I would put these in the repository or in a helper type for the repository. For instance, in my app Barc, I have&nbsp;a <code>BarcodeRepository</code> protocol, and&nbsp;a <code>FileBarcodeRepository</code> that uses SwiftData. Here&#8217;s a small overview of what that looks&nbsp;like:</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">protocol</span> <span class="nc">BarcodeRepository</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">codes</span><span class="p">:</span> <span class="p">[</span><span class="n">Code</span><span class="p">]</span> <span class="p">{</span> <span class="kr">get</span> <span class="kr">throws</span> <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">FileBarcodeRepository</span><span class="p">:</span> <span class="n">BarcodeRepository</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">models</span><span class="p">:</span> <span class="p">[</span><span class="n">BarcodeModel</span><span class="p">]</span> <span class="p">{</span>
        <span class="kr">get</span> <span class="kr">throws</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nv">sort</span> <span class="p">=</span> <span class="n">SortDescriptor</span><span class="p">(</span><span class="err">\</span><span class="n">BarcodeModel</span><span class="p">.</span><span class="n">createdDate</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="p">.</span><span class="bp">reverse</span><span class="p">)</span>
            <span class="kd">let</span> <span class="nv">descriptor</span> <span class="p">=</span> <span class="n">FetchDescriptor</span><span class="p">(</span><span class="n">sortBy</span><span class="p">:</span> <span class="p">[</span><span class="bp">sort</span><span class="p">])</span>
            <span class="k">return</span> <span class="k">try</span> <span class="n">modelContainer</span><span class="p">.</span><span class="n">mainContext</span><span class="p">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">descriptor</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">mapper</span> <span class="p">=</span> <span class="n">BarcodeModelMapper</span><span class="p">()</span>
    <span class="kd">var</span> <span class="nv">codes</span><span class="p">:</span> <span class="p">[</span><span class="n">Code</span><span class="p">]</span> <span class="p">{</span>
        <span class="kr">get</span> <span class="kr">throws</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">try</span> <span class="n">models</span><span class="p">.</span><span class="n">compactMap</span> <span class="p">{</span>
                <span class="k">do</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="k">try</span> <span class="n">mapper</span><span class="p">.</span><span class="n">code</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span>
                <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
                    <span class="n">errorHandler</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">module</span><span class="p">:</span> <span class="s">&quot;Persistence&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">:</span> <span class="s">&quot;FileBarcodeRepository&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">nil</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="nc">BarcodeModelMapper</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">code</span><span class="p">(</span><span class="n">from</span> <span class="n">model</span><span class="p">:</span> <span class="n">BarcodeModel</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="n">Code</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">value</span> <span class="p">=</span> <span class="k">switch</span> <span class="n">model</span><span class="p">.</span><span class="n">type</span> <span class="p">{</span>
            <span class="c1">// elided for length; just a bunch of cases</span>
        <span class="p">}</span>

        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">modelName</span> <span class="p">=</span> <span class="n">model</span><span class="p">.</span><span class="n">name</span> <span class="k">else</span> <span class="p">{</span> <span class="k">throw</span> <span class="n">BarcodeModelMapperError</span><span class="p">.</span><span class="n">noNameSet</span> <span class="p">}</span>
        <span class="kd">let</span> <span class="nv">name</span> <span class="p">=</span> <span class="k">if</span> <span class="n">modelName</span><span class="p">.</span><span class="bp">isEmpty</span> <span class="p">{</span> <span class="n">Strings</span><span class="p">.</span><span class="n">BarcodeModelMapper</span><span class="p">.</span><span class="n">untitledCodeName</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="n">modelName</span> <span class="p">}</span>

        <span class="k">return</span> <span class="n">Code</span><span class="p">(</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="n">value</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
            <span class="n">location</span><span class="p">:</span> <span class="n">model</span><span class="p">.</span><span class="n">location</span><span class="p">.</span><span class="bp">map</span><span class="p">(</span><span class="n">locationMapper</span><span class="p">.</span><span class="n">location</span><span class="p">(</span><span class="n">from</span><span class="p">:)),</span>
            <span class="n">date</span><span class="p">:</span> <span class="n">model</span><span class="p">.</span><span class="n">date</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<blockquote>
<p><strong>Errors</strong>: How to deal with errors? For example, if the CKRecord does not contain a value for id, I would get a crash. Should I use optionals or throw an&nbsp;error?</p>
</blockquote>
<p>I personally throw errors and deal with them at the level it&#8217;s reasonable to deal with them in. Optionals are fine if something is actually optional, but remember that what you&#8217;re trying to do here is avoid having to deal with <span class="caps">API</span> constraints in your view code. So I wouldn&#8217;t make something optional just to avoid&nbsp;errors.</p>
<blockquote>
<p><strong>Repository functions</strong>: Typically I would build functions from a repository that are beyond <span class="caps">CRUD</span>. For example a getTasksDateRange that returns the oldest and most recent due date. Where would I build this? I don&#8217;t want to put it in TaskRepositoryCloudKit as it would be the same logic when using a different storage (i.e. load all the tasks in memory, sort them, and return the first and last). As I can&#8217;t have functions in a protocol, wher do I put&nbsp;it?</p>
</blockquote>
<p>If you want to have something across multiple implementations, use a protocol extension. For&nbsp;instance:</p>
<p><span class="dquo">&#8220;</span>`swift
extension TaskRepository {
    func getTasks(dateRange: Range<Date>) -&gt; [Task] {
        return getAllTasks().filter { task in
            dateRange.contains(task.dueDate)
        }
    }
}&nbsp;&#8220;&#8220;</p>
<p>Because you know all TaskRepository implementations have&nbsp;a <code>getAllTasks()</code>, you can use it in the extension like&nbsp;that.</p>
<blockquote>
<p><strong>Naming</strong>: Is the naming I suggested reasonable? Is it how you would do it in Swift? I chose TaskRepositoryCloudKit so it is listed next to the TaskRepository in the Xcode file browser. If I would need other Data Models to interface a system Xyz I would call them TaskRawXyz - is that&nbsp;reasonable</p>
</blockquote>
<p>I personally put the most specific part first (BarcodeRepository becomes FileBarcodeRepository and PreviewBarcodeRepository and StubBarcodeRepository), but at the end is fine, too. Nothing strange about it either&nbsp;way.</p>
  </div>
</div>
      </div>

      <label for="sidebar-checkbox" class="sidebar-toggle"></label>

      <script>
        (function(document) {
          var i = 0;
          // snip empty header rows since markdown can't
          var rows = document.querySelectorAll('tr');
          for(i=0; i<rows.length; i++) {
            var ths = rows[i].querySelectorAll('th');
            var rowlen = rows[i].children.length;
            if (ths.length > 0 && ths.length === rowlen) {
              rows[i].remove();
            }
          }
        })(document);
      </script>

      <script>
        /* Lanyon & Poole are Copyright (c) 2014 Mark Otto. Adapted to Pelican 20141223 and extended a bit by @thomaswilley */
        (function(document) {
          var toggle = document.querySelector('.sidebar-toggle');
          var sidebar = document.querySelector('#sidebar');
          var checkbox = document.querySelector('#sidebar-checkbox');
          document.addEventListener('click', function(e) {
            var target = e.target;
            if(!checkbox.checked ||
            sidebar.contains(target) ||
            (target === checkbox || target === toggle)) return;
            checkbox.checked = false;
            }, false);
            })(document);
      </script>
     </div>
  </body>
</html>